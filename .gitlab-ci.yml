stages:
  - test
  - build

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  POSTGRES_DB: test_pm
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_HOST: postgres
  REDIS_HOST: redis

services:
  - name: postgres:14-alpine
    alias: postgres
    variables:
      POSTGRES_DB: $POSTGRES_DB
      POSTGRES_USER: $POSTGRES_USER
      POSTGRES_PASSWORD: $POSTGRES_PASSWORD
  - name: redis:7-alpine
    alias: redis

# Template dla Python testów
.python_template: &python_template
  image: python:3.8
  before_script:
    - pip install poetry
    - poetry config virtualenvs.create false
    - poetry install
  variables:
    ENVIRONMENT: test
    POSTGRES__HOST: postgres
    POSTGRES__PORT: 5432
    POSTGRES__USER: $POSTGRES_USER
    POSTGRES__PASSWORD: $POSTGRES_PASSWORD
    POSTGRES__DB: $POSTGRES_DB
    REDIS__HOST: redis
    REDIS__PORT: 6379
    REDIS__DB: 0
    REDIS__USERNAME: ""
    REDIS__PASSWORD: ""

# Linting i formatowanie
lint:
  <<: *python_template
  stage: test
  script:
    - poetry run flake8 .
    - poetry run black --check .
    - poetry run isort --check-only .
  only:
    - merge_requests
    - main
    - develop

# Testy jednostkowe
test:
  <<: *python_template
  stage: test
  script:
    - poetry run python manage.py migrate --noinput
    - poetry run python manage.py test --keepdb
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# Testy handlerów (jeśli są specjalne)
test:handlers:
  <<: *python_template
  stage: test
  script:
    - poetry run python manage.py migrate --noinput
    - poetry run python manage.py test mailing.tests.test_handlers --keepdb -v
  only:
    - merge_requests
    - main
    - develop

# Budowanie obrazu Docker
docker:build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - develop

# Opcjonalnie: Deploy do środowiska testowego
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $STAGING_SERVER >> ~/.ssh/known_hosts
  script:
    - ssh $STAGING_USER@$STAGING_SERVER "cd /path/to/app && docker-compose pull && docker-compose up -d"
  environment:
    name: staging
    url: https://staging.yourdomain.com
  only:
    - develop
  when: manual

# Dependency check (opcjonalnie)
security:
  <<: *python_template
  stage: test
  script:
    - pip install safety
    - safety check
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop
